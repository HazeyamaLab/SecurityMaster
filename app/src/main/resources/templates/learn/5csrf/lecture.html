<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <h2>具体的な脅威の内容</h2>
    ウェブサイトにCSRFの脆弱性がある場合、悪意ある人により、利用者が予期しない処理を実行させられてしまう可能性があります。<br>
    通常通りログインしセッションIDが発行されている状態において，罠サイトのリンク等をクリックしてしまうと，保持しているセッションを基に不正なリクエストを送信されてしまう可能性があります．<br>
    CSRF対策を施さなかった場合，不正なリクエストによって，設定(特にパスワード)の変更や，強制投稿などの被害が出る可能性があります．<br>
    <img th:src="@{/imgs/csrf.png}" alt=""><br>
    <h2>脅威への対処法</h2>
    <h3>処理を実行するページを POST メソッドでアクセスするようにし、その「hidden パラメータ」に秘密情報が挿入されるよう、前のページを自動生成して、実行ページではその値が正しい場合のみ処理を実行する。
    </h3>
    ここでは具体的な例として、「入力画面 → 確認画面 → 登録処理」のようなページ遷移を取り上げて説明します。まず、利用者の入力内容を確認画面として出力する際、合わせて秘密情報を「hidden パラメータ」に出力するようにします。この秘密情報は、セッション管理に使用しているセッション ID を用いる方法の他、セッション ID とは別のもうひとつの ID（第 2 セッション ID）をログイン時に生成
    して用いる方法等が考えられます。生成する ID は暗号論的擬似乱数生成器を用いて、第三者に予測困難なように生成する必要があります。次に確認画面から登録処理のリクエストを受けた際は、リクエスト内容に含まれる「hidden パラメータ」の値と、秘密情報とを比較し、一致しない場合は登録処理を行わないようにします。このような実装であれば、攻撃者が「hidden パラメータ」に出力された秘密情報を入手できなければ、攻撃は成立しません。<br>
    なお、このリクエストは、POST メソッドで行うようにします。これは、GET メソッドで行った場合、外部サイトに送信される Referer に秘密情報が含まれてしまうためです。
    <h3>処理を実行する直前のページで再度パスワードの入力を求め、実行ページでは、再度入力されたパスワードが正しい場合のみ処理を実行する。</h3>
    処理の実行前にパスワード認証を行うことにより、CSRF の脆弱性を解消できます。この対策方法は、上記のパラメータでの対処と比べて実装が簡単となる場合があります。たとえば、セッション管理の仕組みを使用しないで Basic 認証を用いている場合、パラメータでの対処の対策をするには新たに秘密情報を作る必要があります。このとき、暗号論的擬似乱数生成器を簡単には用意できないならば、この対策の方が採用しやすいと言えます。<br>
    しかし，画面設計の仕様変更を要するという問題も抱えています．<br>
    <h3>Referer が正しいリンク元かを確認し、正しい場合のみ処理を実行する。</h3>
    Referer を確認することにより、本来の画面遷移を経ているかどうかを判断できます。Referer が確認できない場合は、処理を実行しないようにします。また Referer が空の場合も、処理を実行しないようにします。これは、Referer を空にしてページを遷移する方法が存在し、攻撃者がその方法を利用してCSRF 攻撃を行う可能性があるためです。<br>
    ただし、ウェブサイトによっては、攻撃者がそのウェブサイト上に罠を設置することができる場合があり、このようなサイトでは、この対策法が有効に機能しない場合があります。また、この対策法を採用すると、ブラウザやパーソナルファイアウォール等の設定で Referer を送信しないようにしている利用者が、そのサイトを利用できなくなる不都合が生じる可能性があります。本対策の採用には、これらの点にも注意してください。<br>

    <a href="/learn/5csrf/test1">問題へ進む</a>

</body>
</html>